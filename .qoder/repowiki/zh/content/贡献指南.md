# 贡献指南

<cite>
**本文档引用的文件**
- [README.md](file://README.md)
- [Cargo.toml](file://Cargo.toml)
- [src/lib.rs](file://src/lib.rs)
- [src/base.rs](file://src/base.rs)
</cite>

## 目录
1. [简介](#简介)
2. [代码风格规范](#代码风格规范)
3. [提交信息格式](#提交信息格式)
4. [PR审查流程](#pr审查流程)
5. [测试要求](#测试要求)
6. [构建与测试方法](#构建与测试方法)
7. [安全敏感性说明](#安全敏感性说明)
8. [联系维护者](#联系维护者)
9. [首次贡献建议](#首次贡献建议)

## 简介
`kspin` 是一个用于内核空间的自旋锁库，能够在临界区中禁用抢占或中断（IRQs）。该项目遵循高标准的开发实践，欢迎社区成员参与其开发和维护。本指南旨在为贡献者提供清晰的指引，涵盖从代码编写到提交审查的完整流程。

**Section sources**
- [README.md](file://README.md#L0-L35)

## 代码风格规范
所有代码必须遵循 Rust 官方格式化工具 `rustfmt` 的默认规则进行格式化。在提交代码前，请确保运行以下命令以统一代码风格：

```bash
cargo fmt
```

该工具将自动调整缩进、换行、括号位置等细节，保证代码库整体一致性。不遵守此规范的 Pull Request 将不会被接受。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L3)

## 提交信息格式
所有 Git 提交信息必须遵循 [Conventional Commits](https://www.conventionalcommits.org/) 规范。标准格式如下：

```
<类型>(<范围>): <简短描述>

<详细说明>
```

常见类型包括：
- `feat`: 新功能
- `fix`: 错误修复
- `docs`: 文档更新
- `style`: 格式调整（不影响逻辑）
- `refactor`: 重构代码
- `test`: 测试相关改动
- `chore`: 构建或辅助工具变动

例如：
```
feat(lock): add support for IRQ state saving
Implements new SpinNoIrq variant that saves interrupt state before locking.
```

**Section sources**
- [README.md](file://README.md#L0-L35)

## PR审查流程
所有 Pull Request 必须经过至少一名核心维护者的审查才能合并。审查重点包括：
- 功能正确性与设计合理性
- 是否符合现有 API 风格
- 单元测试覆盖情况
- 文档完整性
- `unsafe` 代码的安全性分析

CI 系统会自动运行格式检查、单元测试和文档生成。任何失败的 CI 检查都将阻止合并。审查期间请积极回应反馈并及时修改。

**Section sources**
- [README.md](file://README.md#L3)
- [Cargo.toml](file://Cargo.toml#L10)

## 测试要求
所有新增功能必须附带相应的单元测试或文档示例验证。测试应覆盖正常路径、边界条件及错误处理场景。

目前项目已在 `src/base.rs` 中包含完整的测试套件（位于 `#[cfg(test)] mod tests`），涵盖：
- 基本加锁/解锁行为
- 多线程并发访问
- 尝试加锁 (`try_lock`)
- 异常安全（panic 后资源释放）
- 内存布局与 Drop 行为

新特性需添加对应测试用例，并确保 `cargo test` 全部通过。

**Section sources**
- [src/base.rs](file://src/base.rs#L229-L436)

## 构建与测试方法
使用标准 Cargo 命令进行构建和测试：

```bash
# 构建项目
cargo build

# 运行所有测试
cargo test

# 启用 smp 特性进行交叉验证
cargo test --features smp
```

项目支持以下 feature 组合：
- 默认配置：适用于单核环境，优化掉锁状态
- `smp`：启用多核环境支持，使用原子操作管理锁状态

建议在不同 feature 组合下均验证功能正确性。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L15-L18)
- [src/base.rs](file://src/base.rs#L6-L12)

## 安全敏感性说明
本项目涉及底层同步原语，对安全性要求极高。特别注意：
- 所有 `unsafe` 代码块均已标注，并仅用于必要的裸指针解引用和内存模型控制
- 修改 `unsafe` 代码必须提供充分的理由和安全性论证
- 涉及 `unsafe` 的变更需经过更严格的审查，确保满足内存安全和线程安全要求

当前 `unsafe` 使用集中在以下几个方面：
- `UnsafeCell` 的内部数据访问
- 原子布尔值的读写操作
- 强制解锁接口的实现

**Section sources**
- [src/base.rs](file://src/base.rs#L45-L46)
- [src/base.rs](file://src/base.rs#L96)
- [src/base.rs](file://src/base.rs#L159)

## 联系维护者
主要维护者为 Yuekai Jia <equation618@gmail.com>。您可以通过以下方式联系：
- GitHub Issues：报告 bug 或提出功能请求
- Pull Requests：直接提交代码改进
- 项目仓库讨论区：https://github.com/arceos-org/kspin

我们鼓励社区积极参与，共同提升项目质量。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L4)

## 首次贡献建议
对于首次贡献者，建议从以下低风险任务入手：
- 修复文档中的错别字或语法问题
- 补充缺失的示例代码或注释
- 改进 README.md 中的说明文字
- 完善 API 文档中的描述

这些改动有助于熟悉项目结构和协作流程，同时为社区做出实际贡献。一旦熟悉流程，可逐步尝试修复 bug 或实现新特性。

**Section sources**
- [README.md](file://README.md#L13-L35)
- [src/lib.rs](file://src/lib.rs#L5-L36)